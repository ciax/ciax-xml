<?xml version="1.0" encoding="utf-8"?>
<adb xmlns="http://ciax.sum.naoj.org/ciax-xml/adb">
  <app frm_type="ixe" id="ixe" label="MOIRCS Turret">
    <commands xmlns="http://ciax.sum.naoj.org/ciax-xml/adbc">
      <command id="upd" label="Update Status">
        <frmcmd name="getstat" />
        <repeat from="1" to="6">
          <frmcmd name="chkrun">
            <argv>$_</argv>
          </frmcmd>
          <frmcmd name="getp">
            <argv>$_</argv>
          </frmcmd>
          <frmcmd name="getspd">
            <argv>$_</argv>
          </frmcmd>
          <frmcmd name="getrmp">
            <argv>$_</argv>
          </frmcmd>
          <frmcmd name="getofs">
            <argv>$_</argv>
          </frmcmd>
        </repeat>
      </command>
      <command id="chkmov" label="Update Moving Status [1-6]" hidden="true">
        <par>1:6</par>
        <frmcmd name="chkrun">
          <argv>$1</argv>
        </frmcmd>
        <frmcmd name="getp">
          <argv>$1</argv>
        </frmcmd>
      </command>
      <command id="sysinit" label="System Initialize">
        <frmcmd name="initrot" />
        <frmcmd name="initunit" />
        <frmcmd name="initfactor" />
      </command>
      <command id="posinit" label="Position Initialize">
        <repeat from="1" to="6">
          <frmcmd name="init">
            <argv>$_</argv>
          </frmcmd>
          <frmcmd name="chkrun">
            <argv>$_</argv>
          </frmcmd>
        </repeat>
      </command>
      <command id="speed" label="Set Speed [25-800]">
        <par>25:800</par>
        <repeat from="1" to="6">
          <frmcmd name="set">
            <argv format="spd:%d">$_-1</argv>
            <argv>$1</argv>
          </frmcmd>
          <frmcmd name="setspd">
            <argv>$_</argv>
          </frmcmd>
        </repeat>
      </command>
      <command id="ramp" label="Set ramp [200-800]">
        <par>200:800</par>
        <repeat from="1" to="6">
          <frmcmd name="set">
            <argv format="rmp:%d">$_-1</argv>
            <argv>$1</argv>
          </frmcmd>
          <frmcmd name="setrmp">
            <argv>$_</argv>
          </frmcmd>
        </repeat>
      </command>
      <command id="resetp" label="Set 0 Pulses">
        <repeat from="1" to="6">
          <frmcmd name="set">
            <argv format="p:%d">$_-1</argv>
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="setp">
            <argv>$_</argv>
          </frmcmd>
        </repeat>
      </command>
      <command id="backup" label="Backup Pulse,Speed,Offset">
        <frmcmd name="save">
          <argv>p,spd,ofs</argv>
        </frmcmd>
        <frmcmd name="deact" />
      </command>
      <command id="restore" label="Restore Pulse,Speed,Offset">
        <frmcmd name="act" />
        <frmcmd name="load" />
        <repeat from="1" to="6">
          <frmcmd name="setp">
            <argv>$_</argv>
          </frmcmd>
          <frmcmd name="setspd">
            <argv>$_</argv>
          </frmcmd>
          <frmcmd name="setofs">
            <argv>$_</argv>
          </frmcmd>
        </repeat>
      </command>
      <command id="fw" label="Move Forward [1-6(Turret)] [1-(hole)]">
        <par>1:6</par>
        <par>1:</par>
        <frmcmd name="fw">
          <argv>$1</argv>
          <argv format="%d">$2 * 8000</argv>
        </frmcmd>
        <frmcmd name="chkrun">
          <argv>$1</argv>
        </frmcmd>
      </command>
      <command id="bk" label="Move Backward [1-6(Turret)] [1-(hole)]">
        <par>1:6</par>
        <par>1:</par>
        <frmcmd name="bk">
          <argv>$1</argv>
          <argv format="%d">$2 * 8000</argv>
        </frmcmd>
        <frmcmd name="chkrun">
          <argv>$1</argv>
        </frmcmd>
      </command>
      <command id="abs" label="Move Absolute [1-6(Turret)] [0-48(hole)]">
        <par>1:6</par>
        <par>0:48</par>
        <frmcmd name="abs">
          <argv>$1</argv>
          <argv format="%d">$2 * 8000</argv>
        </frmcmd>
        <frmcmd name="chkrun">
          <argv>$1</argv>
        </frmcmd>
      </command>
      <command id="updp" label="Update Pulse" hidden="true">
        <par>1:6</par>
        <frmcmd name="chkrun">
          <argv>$1</argv>
        </frmcmd>
        <frmcmd name="getp">
          <argv>$1</argv>
        </frmcmd>
      </command>
      <command id="stop" label="Stop Run [1-6]" hidden="true">
        <par>1:6</par>
        <frmcmd name="stop">
          <argv>$1</argv>
        </frmcmd>
      </command>
    </commands>
    <status xmlns="http://ciax.sum.naoj.org/ciax-xml/adbs">
      <row label="Group">
        <value id="rdy" label="Comm Ready" symbol="off-warn">
          <binary bit="0" ref="stat" />
        </value>
        <value id="srq" label="SRQ" symbol="off-warn">
          <binary bit="1" ref="stat" />
        </value>
        <value id="pme" label="Program Error" symbol="alarm">
          <binary bit="3" ref="stat" />
        </value>
        <value id="pse" label="Power Stage Error" symbol="alarm">
          <binary bit="4" ref="stat" />
        </value>
        <value id="oes" label="ONE EM Stop" symbol="alarm">
          <binary bit="5" ref="stat" />
        </value>
        <value id="ees" label="EXT EM Stop" symbol="alarm">
          <binary bit="6" ref="stat" />
        </value>
      </row>
      <row label="Group">
        <value id="trm" label="Terminal Mode" symbol="off-warn">
          <binary bit="2" ref="stat" />
        </value>
        <value id="cmd" label="Computer Mode" symbol="off-warn">
          <binary bit="7" ref="stat" />
        </value>
      </row>
      <repeat from="1" to="6">
        <row label="Group">
          <value id="r%d" label="Running %d">
            <string ref="run" index="$_-1" />
          </value>
          <value id="p%d" label="Pulse %d">
            <int ref="p" index="$_-1" />
          </value>
          <value id="spd%d" label="Speed %d">
            <int ref="spd" index="$_-1" />
          </value>
          <value id="rmp%d" label="Ramp %d">
            <int ref="spd" index="$_-1" />
          </value>
          <value id="ofs%d" label="Offset %d">
            <int ref="ofs" index="$_-1" />
          </value>
        </row>
      </repeat>
    </status>
    <watch interval="1" xmlns="http://ciax.sum.naoj.org/ciax-xml/wdb">
      <event label="Update Status">
        <range ref="elapse">3600:</range>
        <exec name="upd"></exec>
      </event>
      <repeat from="1" to="6">
        <event label="Moving %d" block="(fw|bk|abs) %d">
          <pattern ref="r%d">N</pattern>
          <exec name="updp">
            <argv>$_</argv>
          </exec>
        </event>
        <event>
          <onchange ref="int"></onchange>
          <pattern ref="r%d">N</pattern>
          <exec name="stop">
            <argv>$_</argv>
          </exec>
        </event>
      </repeat>
    </watch>
  </app>
</adb>