<?xml version="1.0" encoding="utf-8"?>
<cdb xmlns="http://ciax.sum.naoj.org/ciax-xml/cdb">
  <app frame="ixe" id="ixe" label="MOIRCS Turret">
    <commands xmlns="http://ciax.sum.naoj.org/ciax-xml/cdbc">
      <cmdset id="upd" label="Update Status">
        <command name="getstat" />
        <repeat from="1" to="6">
          <command name="chkrun">
            <argv>$_</argv>
          </command>
          <command name="getp">
            <argv>$_</argv>
          </command>
          <command name="getspd">
            <argv>$_</argv>
          </command>
          <command name="getrmp">
            <argv>$_</argv>
          </command>
          <command name="getofs">
            <argv>$_</argv>
          </command>
        </repeat>
      </cmdset>
      <cmdset id="sysinit" label="System Initialize">
        <command name="initrot" />
        <command name="initunit" />
        <command name="initfactor" />
      </cmdset>
      <cmdset id="posinit" label="Position Initialize">
        <repeat from="1" to="6">
          <command name="init">
            <argv>$_</argv>
          </command>
          <command name="chkrun">
            <argv>$_</argv>
          </command>
        </repeat>
      </cmdset>
      <cmdset id="speed" label="Set Speed [25-800]">
        <repeat from="1" to="6">
          <command name="set">
            <argv format="spd:%d">$_-1</argv>
            <argv valid="25:800">$1</argv>
          </command>
          <command name="setspd">
            <argv>$_</argv>
          </command>
        </repeat>
      </cmdset>
      <cmdset id="ramp" label="Set ramp [200-800]">
        <repeat from="1" to="6">
          <command name="set">
            <argv format="rmp:%d">$_-1</argv>
            <argv valid="200:800">$1</argv>
          </command>
          <command name="setrmp">
            <argv>$_</argv>
          </command>
        </repeat>
      </cmdset>
      <cmdset id="resetp" label="Set 0 Pulses">
        <repeat from="1" to="6">
          <command name="set">
            <argv format="p:%d">$_-1</argv>
            <argv>0</argv>
          </command>
          <command name="setp">
            <argv>$_</argv>
          </command>
        </repeat>
      </cmdset>
      <cmdset id="backup" label="Backup Pulse,Speed,Offset">
        <command name="save">
          <argv>p,spd,ofs</argv>
        </command>
        <command name="deact" />
      </cmdset>
      <cmdset id="restore" label="Restore Pulse,Speed,Offset">
        <command name="act" />
        <command name="load" />
        <repeat from="1" to="6">
          <command name="setp">
            <argv>$_</argv>
          </command>
          <command name="setspd">
            <argv>$_</argv>
          </command>
          <command name="setofs">
            <argv>$_</argv>
          </command>
        </repeat>
      </cmdset>
      <cmdset id="fw" label="Move Forward [1-6(Turret)] [1-(hole)]">
        <command name="fw">
          <argv valid="1:6">$1</argv>
          <argv valid="1:" format="%d">$2 * 8000</argv>
        </command>
        <command name="chkrun">
          <argv>$1</argv>
        </command>
      </cmdset>
      <cmdset id="bk" label="Move Backward [1-6(Turret)] [1-(hole)]">
        <command name="bk">
          <argv valid="1:6">$1</argv>
          <argv format="%d" valid="1:">$2 * 8000</argv>
        </command>
        <command name="chkrun">
          <argv>$1</argv>
        </command>
      </cmdset>
      <cmdset id="abs" label="Move Absolute [1-6(Turret)] [0-48(hole)]">
        <command name="abs">
          <argv valid="1:6">$1</argv>
          <argv format="%d" valid="0:48">$2 * 8000</argv>
        </command>
        <command name="chkrun">
          <argv>$1</argv>
        </command>
      </cmdset>
    </commands>
    <status xmlns="http://ciax.sum.naoj.org/ciax-xml/cdbs">
      <row label="Group">
        <value id="rdy" label="Comm Ready" symbol="off-warn">
          <binary bit="0" ref="stat" />
        </value>
        <value id="srq" label="SRQ" symbol="off-warn">
          <binary bit="1" ref="stat" />
        </value>
        <value id="pme" label="Program Error" symbol="alarm">
          <binary bit="3" ref="stat" />
        </value>
        <value id="pse" label="Power Stage Error" symbol="alarm">
          <binary bit="4" ref="stat" />
        </value>
        <value id="oes" label="ONE EM Stop" symbol="alarm">
          <binary bit="5" ref="stat" />
        </value>
        <value id="ees" label="EXT EM Stop" symbol="alarm">
          <binary bit="6" ref="stat" />
        </value>
      </row>
      <row label="Group">
        <value id="trm" label="Terminal Mode" symbol="off-warn">
          <binary bit="2" ref="stat" />
        </value>
        <value id="cmd" label="Computer Mode" symbol="off-warn">
          <binary bit="7" ref="stat" />
        </value>
      </row>
      <repeat from="1" to="6">
        <row label="Group">
          <value id="r%d" label="Running %d">
            <string ref="run:$_-1" />
          </value>
          <value id="p%d" label="Pulse %d">
            <int ref="p:$_-1" />
          </value>
          <value id="spd%d" label="Speed %d">
            <int ref="spd:$_-1" />
          </value>
          <value id="rmp%d" label="Ramp %d">
            <int ref="spd:$_-1" />
          </value>
          <value id="ofs%d" label="Offset %d">
            <int ref="ofs:$_-1" />
          </value>
        </row>
      </repeat>
    </status>
    <watch interval="1" xmlns="http://ciax.sum.naoj.org/ciax-xml/wdb">
      <repeat from="1" to="6">
        <periodic label="Update Status" period="3600">
          <command name="getstat" />
          <command name="chkrun">
            <argv>$_</argv>
          </command>
          <command name="getp">
            <argv>$_</argv>
          </command>
          <command name="getspd">
            <argv>$_</argv>
          </command>
          <command name="getofs">
            <argv>$_</argv>
          </command>
        </periodic>
        <while label="Moving %d" blocking="(fw|bk|abs) %d">
          <condition operator="and">
            <value ref="r%d">N</value>
          </condition>
          <interrupt name="stop">
            <argv>$_</argv>
          </interrupt>
          <command name="chkrun">
            <argv>$_</argv>
          </command>
          <command name="getp">
            <argv>$_</argv>
          </command>
        </while>
      </repeat>
    </watch>
  </app>
</cdb>
