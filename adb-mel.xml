<?xml version="1.0" encoding="utf-8"?>
<adb xmlns="http://ciax.sum.naoj.org/ciax-xml/adb">
  <app frm_type="mel" id="mel" label="Cart PLC" version="2">
    <commands xmlns="http://ciax.sum.naoj.org/ciax-xml/adbc">
      <group id="gint" caption="Interrupt Commands" column="2">
        <command id="upd" label="Status update">
          <frmcmd name="getstat" />
          <frmcmd name="getcmd" />
        </command>
        <command id="emstop" label="Emergency Stop">
          <frmcmd name="stop">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="sleep">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="clear" />
          <frmcmd name="getstat" />
        </command>
        <command id="pause" label="Pause Action">
          <frmcmd name="stop">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="sleep">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="clear" />
          <frmcmd name="getstat" />
        </command>
        <command id="reset" label="Reset Error or Pause">
          <frmcmd name="stop">
            <argv>5</argv>
          </frmcmd>
          <frmcmd name="sleep">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="clear" />
          <frmcmd name="getstat" />
        </command>
        <command id="ready" label="Ready mode">
          <frmcmd name="stop">
            <argv>6</argv>
          </frmcmd>
          <frmcmd name="sleep">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
          <frmcmd name="getstat" />
        </command>
        <command id="cancel" label="Command Cancel">
          <frmcmd name="stop">
            <argv>4</argv>
          </frmcmd>
          <frmcmd name="sleep">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="clear" />
          <frmcmd name="getstat" />
        </command>
        <command id="cstop" label="Stop at Next Tag">
          <frmcmd name="stop">
            <argv>7</argv>
          </frmcmd>
          <frmcmd name="sleep">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="clear" />
          <frmcmd name="getstat" />
        </command>
        <command id="clear" label="Clear Cmd Flag" hidden="true">
          <frmcmd name="clear" />
          <frmcmd name="getcmd" />
        </command>
      </group>
      <group id="gmov" caption="Moving Commands" column="2">
        <command id="run" label="Run to Tag [1-12]">
          <par>1:12</par>
          <frmcmd name="set_tag">
            <argv>$1</argv>
          </frmcmd>
          <frmcmd name="start">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="lift" label="Lift Jack Level [0-4]">
          <par>0:4</par>
          <frmcmd name="set_pos">
            <argv>$1</argv>
          </frmcmd>
          <frmcmd name="start">
            <argv>8</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="fwd" label="Run Forward">
          <frmcmd name="set_tag">
            <argv>98</argv>
          </frmcmd>
          <frmcmd name="start">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="bak" label="Run Backword">
          <frmcmd name="set_tag">
            <argv>99</argv>
          </frmcmd>
          <frmcmd name="start">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
      </group>
      <group id="gins" caption="Instrument Assign" column="2">
        <command id="comics" label="COMICS">
          <frmcmd name="set_ins">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="getstat" />
        </command>
        <command id="ciao" label="CIAO">
          <frmcmd name="set_ins">
            <argv>2</argv>
          </frmcmd>
          <frmcmd name="getstat" />
        </command>
        <command id="focas" label="FOCAS">
          <frmcmd name="set_ins">
            <argv>3</argv>
          </frmcmd>
          <frmcmd name="getstat" />
        </command>
        <command id="moircs" label="MOIRCS">
          <frmcmd name="set_ins">
            <argv>4</argv>
          </frmcmd>
          <frmcmd name="getstat" />
        </command>
        <command id="k3d" label="Kyoto 3D">
          <frmcmd name="set_ins">
            <argv>5</argv>
          </frmcmd>
          <frmcmd name="getstat" />
        </command>
      </group>
      <group id="gchg" caption="Charging Commands" column="2">
        <command id="chgon" label="Start Charging">
          <frmcmd name="start">
            <argv>15</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="chgoff" label="Stop Charging">
          <frmcmd name="stop">
            <argv format="%d">3</argv>
          </frmcmd>
          <frmcmd name="clear" />
          <frmcmd name="getstat" />
        </command>
      </group>
      <group id="gmtn" caption="Maintenance Commands" column="2">
        <command id="get_tbl" label="Get Jack Table">
          <frmcmd name="rw_tbl">
            <argv>1</argv>
          </frmcmd>
          <repeat counter="t" from="0" to="5">
            <repeat counter="j" from="0" to="3">
              <frmcmd name="get_tbl">
                <argv>$t</argv>
                <argv>$j</argv>
              </frmcmd>
            </repeat>
          </repeat>
        </command>
        <command id="set_tbl" label="Set Jack Table">
          <repeat counter="t" from="0" to="5">
            <repeat counter="j" from="0" to="3">
              <frmcmd name="set_tbl">
                <argv>$t</argv>
                <argv>$j</argv>
              </frmcmd>
            </repeat>
          </repeat>
          <frmcmd name="rw_tbl">
            <argv>0</argv>
          </frmcmd>
        </command>
      </group>
    </commands>
    <status xmlns="http://ciax.sum.naoj.org/ciax-xml/adbs" table="mel">
      <group id="gs" caption="Status" column="3">
        <value id="rdy" label="READY" symbol="normal">
          <binary ref="x" index="0" bit="0" />
        </value>
        <value id="stp" label="STOPPING" symbol="warn">
          <binary ref="x" index="0" bit="3" />
        </value>
        <value id="pse" label="PAUSE" symbol="warn">
          <binary ref="x" index="0" bit="1" />
        </value>
        <value id="emg" label="ENERGENCY" symbol="alarm">
          <binary ref="x" index="0" bit="2" />
        </value>
        <value id="ecode" label="EXIT CODE" symbol="ecode" format="%04X">
          <int ref="ecode" />
        </value>
        <value id="flt" label="Fault" symbol="alarm">
          <binary ref="x" index="0" bit="7" />
        </value>
      </group>
      <group id="gt" caption="Trigger" column="4">
        <value id="acp" label="CMD ENB" symbol="acp">
          <binary label="Command Receive Enable" ref="x" index="32" bit="0" />
        </value>
        <value id="isu" label="ISSUED" symbol="nonzero">
          <binary ref="c" index="2" bit="0" />
          <binary ref="c" index="2" bit="8" />
          <binary ref="c" index="2" bit="15" />
        </value>
      </group>
      <group id="grun" caption="Running" column="4">
        <value id="run" label="Motion" symbol="exec">
          <binary ref="x" index="0" bit="4" />
        </value>
        <value id="cps" label="Current">
          <int ref="x" index="25" />
        </value>
        <value id="dps" label="Destination">
          <int ref="x" index="26" />
        </value>
      </group>
      <group id="gjak" caption="Jacking" column="4">
        <value id="jak" label="Motion" symbol="exec">
          <binary ref="x" index="0" bit="5" />
        </value>
        <value id="jlv" label="Level" symbol="jlv">
          <int ref="x" index="27" />
        </value>
        <value id="corn" label="Corn" symbol="corn">
          <binary ref="x" index="19" bit="5" />
          <binary ref="x" index="19" bit="13" />
          <binary ref="x" index="20" bit="5" />
          <binary ref="x" index="20" bit="13" />
        </value>
      </group>
      <group id="gchg" caption="Charging" column="4">
        <value id="bvl" label="Battery(V)" symbol="bvl" format="%2.2f">
          <float ref="x" index="22" formula="$#/100" />
        </value>
        <value id="con" label="CHARGING" symbol="exec">
          <binary ref="x" index="0" bit="6" />
        </value>
      </group>
      <group id="gmot" caption="Running Motor Stat" column="2">
        <value id="msr" label="Servo R" symbol="normal">
          <binary ref="x" index="0" bit="8" inv="true" />
        </value>
        <value id="mdar" label="D/A R" symbol="motor">
          <int ref="x" index="7" />
        </value>
        <value id="msl" label="Servo L" symbol="normal">
          <binary ref="x" index="0" bit="9" inv="true" />
        </value>
        <value id="mdal" label="D/A L" symbol="motor">
          <int ref="x" index="8" />
        </value>
      </group>
      <group id="gjm" caption="Jacking Motor Stat" column="4">
        <repeat from="1" to="4">
          <value id="js%d" label="Servo %d" symbol="normal">
            <binary ref="x" index="0" bit="9+$_" inv="true" />
          </value>
          <value id="jh%d" label="Height %d">
            <float ref="x" index="8+2*$_" />
            <float ref="x" index="9+2*$_" formula="$#*65536" />
          </value>
          <value id="cn%d" label="Land %d" symbol="warn">
            <binary ref="x" index="19+($_-1)/2" bit="13-($_%2)*8" />
          </value>
          <value id="lc%d" label="Load %d">
            <float ref="x" index="$_+47" />
          </value>
        </repeat>
      </group>
      <group id="gins" caption="Instrument" column="2">
        <value id="ist" label="ID" symbol="ist">
          <int ref="x" index="23" />
        </value>
        <value id="ion" label="Loading" symbol="corn">
          <binary ref="x" index="4" bit="8" />
          <binary ref="x" index="4" bit="9" />
          <binary ref="x" index="4" bit="10" />
          <binary ref="x" index="4" bit="11" />
        </value>
      </group>
    </status>
    <watch xmlns="http://ciax.sum.naoj.org/ciax-xml/wdb" interval="1">
      <event label="During Issued">
        <pattern ref="isu" inv="1">0</pattern>
        <block name="run" />
        <block name="lift" />
        <block name="chgon" />
        <exec name="upd"></exec>
      </event>
      <event label="Command Receive">
        <onchange ref="acp"></onchange>
        <pattern ref="acp">0</pattern>
        <exec name="clear"></exec>
        <exec name="upd"></exec>
      </event>
      <event label="While Running">
        <pattern ref="run">1</pattern>
        <block name="run" />
        <block name="lift" />
        <block name="chgon" />
        <block name="chgoff" />
        <int name="pause" />
        <exec name="upd"></exec>
      </event>
      <event label="While Jacking">
        <pattern ref="jak">1</pattern>
        <block name="run" />
        <block name="lift" />
        <block name="chgon" />
        <block name="chgoff" />
        <int name="pause" />
        <exec name="upd" />
      </event>
    </watch>
  </app>
</adb>