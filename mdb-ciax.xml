<?xml version="1.0" encoding="utf-8"?>
<mdb xmlns="http://ciax.sum.naoj.org/ciax-xml/mdb">
  <macro id="ciax" version="1" label="Cart Macro" port="55555">
    <item id="runf" label="Run Forward to Tag">
      <goal label="On Tag?">
        <stat site="crt" var="cps" inv="true">0</stat>
      </goal>
      <mesg label="Clear the way?"/>
      <wait retry="5" label="Ready?">
        <stat var="rdy" site="crt">ON</stat>
      </wait>
      <exec site="crt" name="runf"></exec>
      <wait retry="40" label="Run end?">
        <stat var="run" site="crt">OFF</stat>
      </wait>
    </item>
    <item id="run" label="Run to Tag [1-12]">
      <par_num name="tag">1:12</par_num>
      <goal label="On Destination Tag?">
        <stat var="cps" site="crt">$1</stat>
      </goal>
      <check label="Ready?">
        <stat var="rdy" site="crt">ON</stat>
      </check>
      <exec site="crt" name="run">
        <argv>$1</argv>
      </exec>
      <wait retry="120" label="Run end?">
        <stat label="Running" var="run" site="crt">OFF</stat>
      </wait>
    </item>
    <item id="lift" label="Jack UP Level [1-4]">
      <par_num>1:4</par_num>
      <goal label="On Destination Level?">
        <stat var="jlv" site="crt">$1</stat>
      </goal>
      <check label="Ready?">
        <stat var="rdy" site="crt">ON</stat>
      </check>
      <exec site="crt" name="lift">
        <argv>$1</argv>
      </exec>
      <wait label="Jacking" retry="40">
        <stat var="jak" site="crt">OFF</stat>
      </wait>
    </item>
    <!--Jack Command-->
    <item id="fju0" label="InR0 Jkup at FIX">
      <par_reg>...</par_reg>
      <goal label="Jack DW?">
        <stat site="$1" var="fjb">DW</stat>
      </goal>
      <check label="HOOK?">
        <stat site="$1" var="fis">ON</stat>
        <stat site="$1" var="fhk">HOOK</stat>
      </check>
      <exec site="$1" name="fjdw"></exec>
      <wait label="Jacking" retry="40">
        <stat site="$1" var="exe">OFF</stat>
      </wait>
    </item>
    <item id="fjd0" label="InR0 Jkdw at FIX">
      <goal label="Instrument ON?">
        <stat site="$1" var="fis">ON</stat>
      </goal>
      <check label="HOOK?">
        <stat site="$1" var="fhk">HOOK</stat>
      </check>
      <exec site="$1" name="fjup"></exec>
      <wait label="Jacking" retry="40">
        <stat site="$1" var="exe">OFF</stat>
      </wait>
    </item>
    <item id="fju4" label="InR4 Jkup at FIX.IR">
      <goal label="Jack Up?">
        <stat site="$1" var="fjb">UP</stat>
      </goal>
      <check label="UNHOOK?">
        <stat site="$1" var="fhk">UNHK</stat>
      </check>
      <exec site="$1" name="fjup"></exec>
      <wait label="Jacking" retry="40">
        <stat site="$1" var="exe">OFF</stat>
      </wait>
    </item>
    <item id="fjd4" label="InR4 Jkdw at FIX.IR">
      <goal label="Jack Dw?">
        <stat site="$1" var="fjb">DW</stat>
      </goal>
      <check label="UNHOOK?">
        <stat site="$1" var="fhk">UNHK</stat>
      </check>
      <exec site="$1" name="fjdw"></exec>
      <wait label="Jacking" retry="40">
        <stat site="$1" var="exe">OFF</stat>
      </wait>
    </item>
    <!--Jack & Rotate-->
    <item id="jupd" label="HookUp at FIX.IR">
      <goal label="Instrument ON?">
        <stat site="dsi" var="fis">ON</stat>
      </goal>
      <check label="CART ON TAG?">
        <stat site="crt" var="cps">12</stat>
        <stat site="crt" var="jlv">H</stat>
      </check>
      <exec site="dsi" name="fhook"></exec>
      <wait label="Jacking" retry="40">
        <stat site="dsi" var="exe">OFF</stat>
      </wait>
      <mcr name="fju0">
        <argv>dsi</argv>
      </mcr>
    </item>
    <!--Transer-->
    <item id="trsi" label="MOV.IR Trans Backward w/SITET">
      <goal label="Transer Stored?">
        <stat site="dsi" var="mtr">BK</stat>
      </goal>
      <check label="CART CLEAR?">
        <stat site="crt" var="cps" inv="true">12</stat>
        <stat site="crt" var="cps" inv="true">11</stat>
      </check>
      <exec site="dsi" name="rotin"></exec>
      <wait label="Rotating" retry="20">
        <stat site="dsi" var="exe">OFF</stat>
      </wait>
      <exec site="dsi" name="trin"></exec>
      <wait label="Moving" retry="60">
        <stat site="dsi" var="exe">OFF</stat>
      </wait>
    </item>
    <!--Run & Transer-->
    <item id="r08to" label="Leave IR from Tag 8 to [2-7]">
      <par_num>2:7</par_num>
      <goal label="Leave Cart and Transer Stored?">
        <stat site="crt" var="cps" inv="true">8</stat>
        <stat site="dsi" var="mtr">BK</stat>
      </goal>
      <check label="CART CLEAR?">
        <stat site="crt" var="cps">8</stat>
        <stat site="crt" var="ion">OFF</stat>
      </check>
      <exec site="crt" name="run">
        <argv>$1</argv>
      </exec>
      <mcr async="true" name="trsi" />
      <wait retry="120" label="Run end?">
        <stat label="Running" site="crt" var="run">OFF</stat>
      </wait>
    </item>
  </macro>
</mdb>