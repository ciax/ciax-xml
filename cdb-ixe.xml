<?xml version="1.0" encoding="utf-8"?>
<cdb xsi:schemaLocation="http://ciax.sum.naoj.org/ciax-xml/schema/cdb.xsd" xmlns="http://ciax.sum.naoj.org/ciax-xml/cdb" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <class frame="ixe" id="ixe" label="MOIRCS Turret">
    <commands xmlns="http://ciax.sum.naoj.org/ciax-xml/cdbc">
      <session id="upd" label="Update Status">
        <statement format="getstat" />
        <repeat from="1" to="6">
          <statement format="chkrun %d">
            <argv>$_</argv>
          </statement>
          <statement format="getp %d">
            <argv>$_</argv>
          </statement>
          <statement format="getspd %d">
            <argv>$_</argv>
          </statement>
          <statement format="getofs %d">
            <argv>$_</argv>
          </statement>
        </repeat>
      </session>
      <session id="sysinit" label="System Initialize">
        <statement format="initrot" />
        <statement format="initunit" />
        <statement format="initfactor" />
      </session>
      <session id="posinit" label="Position Initialize">
        <repeat from="1" to="6">
          <statement format="init %d">
            <argv>$_</argv>
          </statement>
          <statement format="chkrun %d">
            <argv>$_</argv>
          </statement>
        </repeat>
      </session>
      <session id="speed" label="Set Speed [0-800]">
        <parameters>
          <par label="[0-800]" validate="range">0:800</par>
        </parameters>
        <repeat from="1" to="6">
          <statement format="set spd:%d %d">
            <argv>$_-1</argv>
            <argv>$1</argv>
          </statement>
          <statement format="setspd %d">
            <argv>$_</argv>
          </statement>
        </repeat>
      </session>
      <session id="resetp" label="Set 0 Pulses">
        <repeat from="1" to="6">
          <statement format="set p:%d 0">
            <argv>$_-1</argv>
          </statement>
          <statement format="setp %d">
            <argv>$_</argv>
          </statement>
        </repeat>
      </session>
      <session id="backup" label="Backup Pulse,Speed,Offset">
        <statement format="save p,spd,ofs" />
        <statement format="deact" />
      </session>
      <session id="restore" label="Restore Pulse,Speed,Offset">
        <statement format="act" />
        <statement format="load" />
        <repeat from="1" to="6">
          <statement format="setp %d">
            <argv>$_</argv>
          </statement>
          <statement format="setspd %d">
            <argv>$_</argv>
          </statement>
          <statement format="setofs %d">
            <argv>$_</argv>
          </statement>
        </repeat>
      </session>
      <session id="fw" label="Move Forward [1-6] [1-(hole)]">
        <parameters>
          <par label="[1-6(Turret)]" validate="range">1:6</par>
          <par label="[1-(hole)]" validate="range">1:</par>
        </parameters>
        <statement format="fw %d %d">
          <argv>$1</argv>
          <argv>$2 * 8000</argv>
        </statement>
        <statement format="chkrun %d">
          <argv>$1</argv>
        </statement>
      </session>
      <session id="bk" label="Move Backward [1-6] [1-(hole)]">
        <parameters>
          <par label="[1-6(Turret)]" validate="range">1:6</par>
          <par label="[1-(hole)]" validate="range">1:</par>
        </parameters>
        <statement format="bk %d %d">
          <argv>$1</argv>
          <argv>$2 * 8000</argv>
        </statement>
        <statement format="chkrun %d">
          <argv>$1</argv>
        </statement>
      </session>
      <session id="abs" label="Move Absolute [1-6] [0-48(hole)]">
        <parameters>
          <par label="[1-6]" validate="range">1:6</par>
          <par label="[0-48(hole)]" validate="range">0:48</par>
        </parameters>
        <statement format="abs %d %d">
          <argv>$1</argv>
          <argv>$2 * 8000</argv>
        </statement>
        <statement format="chkrun %d">
          <argv>$1</argv>
        </statement>
      </session>
      <session id="upp">
        <!--Update Pulse [1-6]-->
        <parameters>
          <par label="[1-6]" validate="range">1:6</par>
        </parameters>
        <statement format="chkrun %d">
          <argv>$1</argv>
        </statement>
        <statement format="getp %d">
          <argv>$1</argv>
        </statement>
      </session>
      <session id="stop">
        <!--Motor Stop [1-6]-->
        <parameters>
          <par label="[1-6]" validate="range">1:6</par>
        </parameters>
        <statement format="stop %d">
          <argv>$1</argv>
        </statement>
      </session>
    </commands>
    <watch interval="1" xmlns="http://ciax.sum.naoj.org/ciax-xml/cdbw">
      <event label="Update Status">
        <periodic period="3600" />
        <command>upd</command>
      </event>
      <repeat from="1" to="6">
        <event blocking="(fw|bk|abs) $_" interrupt="stop $_" label="Moving $_">
          <while ref="r$_" val="N" />
          <command>upp $_</command>
        </event>
      </repeat>
    </watch>
    <status xmlns="http://ciax.sum.naoj.org/ciax-xml/cdbs">
      <value format="%s" id="rdy" label="Comm Ready" group="s1">
        <binary bit="0" ref="stat" />
      </value>
      <value format="%s" id="srq" label="SRQ" group="s1">
        <binary bit="1" ref="stat" />
      </value>
      <value format="%s" id="pme" label="Program Error" group="s1">
        <binary bit="3" ref="stat" />
      </value>
      <value format="%s" id="pse" label="Power Stage Error" group="s1">
        <binary bit="4" ref="stat" />
      </value>
      <value format="%s" id="oes" label="ONE EM Stop" group="s1">
        <binary bit="5" ref="stat" />
      </value>
      <value format="%s" id="ees" label="EXT EM Stop" group="s1">
        <binary bit="6" ref="stat" />
      </value>
      <value format="%s" id="trm" label="Terminal Mode" group="s2">
        <binary bit="2" ref="stat" />
      </value>
      <value format="%s" id="cmd" label="Computer Mode" group="s2">
        <binary bit="7" ref="stat" />
      </value>
      <repeat from="1" to="6">
        <value format="%s" id="r$_" label="Running $_" group="r$_">
          <string ref="run:$_-1" />
        </value>
        <value format="%d" id="p$_" label="Pulse $_" group="r$_">
          <int ref="p:$_-1" />
        </value>
        <value format="%d" id="spd$_" label="Speed $_" group="r$_">
          <int ref="spd:$_-1" />
        </value>
        <value format="%d" id="ofs$_" label="Offset $_" group="r$_">
          <int ref="ofs:$_-1" />
        </value>
      </repeat>
    </status>
    <symbol xmlns="http://ciax.sum.naoj.org/ciax-xml/sdb">
      <enum id="rdy" ref="off-warn" />
      <enum id="srq" ref="off-warn" />
      <enum id="pme" ref="alarm" />
      <enum id="pse" ref="alarm" />
      <enum id="oes" ref="alarm" />
      <enum id="ees" ref="alarm" />
      <enum id="trm" ref="off-warn" />
      <enum id="cmd" ref="off-warn" />
    </symbol>
  </class>
</cdb>
