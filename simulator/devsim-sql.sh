#!/bin/bash
# Use sql file generated by log2sql
#alias devsim
kilpid(){
    while read pid ;do
        kill $pid
    done < $pidfile
    :> $pidfile
}
server(){
    kilpid
    # To keep alive an exec command, it should be first item
    socat exec:"$0 -" udp-recvfrom:8888,reuseaddr,fork &
    echo $! >> $pidfile
    exit
}
# sql commands
maxtime(){
    sqlite3 $sqlfile <<EOF
select max(time) from stream;
EOF
}
mintime(){
    sqlite3 $sqlfile <<EOF
select min(time) from stream;
EOF
}
nexttime(){
    sqlite3 $sqlfile <<EOF | grep .
select min(time) from stream
 where time > ${time:=0}
 ${site:+ and id == '$site'}
 ${input:+and snd == '$input'}
;
EOF
}
fields(){
    sqlite3 -line $sqlfile <<EOF | tr -d ' '
select * from stream
 where time == $time; 
EOF
}
# main
next(){
    ms=$(now)
    time=$(nexttime) && {
        leadtime=$(( $(now)-$ms ))
        return
    }
    warn "== Rewinded =="
    time=$(nexttime) || {
        warn "== Not found =="
        return 1
    }
}
setvar(){
    while read line; do
        eval "$line"
    done < <(fields)
}
# verbose display
progress(){
    pc=$(echo "($time-$min)/ $total * 100" | bc -l )
    warn "  "$(printf "Found at %s (%.2f%%) in %d msec" $time $pc $leadtime )
}
waitdur(){
    [[ $dur =~ \. ]] && dur=$(echo "$dur * 1000 / 1"|bc) # remove at next log conversion 
    rest=$(( $dur > $leadtime ? $dur - $leadtime : 0))
    (( $rest > 0 )) || return
    sleep $(echo "$rest / 1000" | bc -l)
    warn "  Slept $rest/$dur msec"
}
# Unix time with msec
now(){
    a=$(date +%s%N)
    echo ${a:0:13}
}
warn(){ echo "DEVSIM:$*" > /dev/stderr; }
#########################
pidfile="$HOME/.var/run/devsim.pid"
mkdir -p $HOME/.var/run
[ "$1" ] ||{  echo "Usage:${0##*/} (-d) [site]";kilpid;exit 1; }
[ "$1" = -d ] && server
[ "$1" = - ] || site=$1
time=0
sqlfile="$HOME/.var/log/stream.sq3"
min=$(mintime)
max=$(maxtime)
total=$(( $max - $min ))
warn "== Init =="
while : ; do
    warn "  Ready"
    input=$(input64)
    warn "  Send [${input:0:8}...]"
    next || continue
    setvar
    progress
    [ "$dur" ] || { warn "No respond"; continue; }
    waitdur
    warn "  Recieve [${rcv:0:8}...]"
    echo -n $rcv|base64 -d
done

