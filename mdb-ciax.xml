<?xml version="1.0" encoding="utf-8"?>
<mdb xmlns="http://ciax.sum.naoj.org/ciax-xml/mdb">
  <macro id="ciax" version="1" label="Cart Macro">
    <command id="runf" label="Run Forward to Tag">
      <break label="On Tag?">
        <stat ins="crt" ref="cpos" inv="true">0</stat>
      </break>
      <wait retry="5" label="Ready?">
        <stat ref="rdy" ins="crt">ON</stat>
      </wait>
      <exec ins="crt" name="runf"></exec>
      <wait retry="40" label="Run end?">
        <stat ref="run" ins="crt">OFF</stat>
      </wait>
      <check label="Destination?">
        <stat ref="cpos" inv="true" ins="crt">0</stat>
      </check>
    </command>
    <command id="run" label="Run to Tag [1-12]">
      <par>1:12</par>
      <break label="On Destination Tag?">
        <stat ref="cpos" ins="crt">$1</stat>
      </break>
      <check label="Ready?">
        <stat ref="rdy" ins="crt">ON</stat>
      </check>
      <exec ins="crt" name="run">
        <argv>$1</argv>
      </exec>
      <wait retry="120" label="Run end?">
        <stat label="Running" ref="run" ins="crt">OFF</stat>
      </wait>
      <check label="On Destination Tag ?">
        <stat ref="cpos" ins="crt">$1</stat>
      </check>
    </command>
    <command id="lift" label="Jack UP Level [1-4]">
      <par>1:4</par>
      <break label="On Destination Level?">
        <stat ref="jpos" ins="crt">$1</stat>
      </break>
      <check label="Ready?">
        <stat ref="rdy" ins="crt">ON</stat>
      </check>
      <exec ins="crt" name="lift">
        <argv>$1</argv>
      </exec>
      <wait label="Jacking" retry="40">
        <stat ref="jak" ins="crt">OFF</stat>
      </wait>
      <check label="On Destination Level?">
        <stat ref="jpos" ins="crt">$1</stat>
      </check>
    </command>
    <!--Jack Command-->
    <command id="ju0d" label="InR0 Jkup at FIX.IR">
      <break label="Jack DW?">
        <stat ins="dsi" ref="fjb">DW</stat>
      </break>
      <check label="HOOK?">
        <stat ins="dsi" ref="fis">ON</stat>
        <stat ins="dsi" ref="fhk">HOOK</stat>
      </check>
      <exec ins="dsi" name="fjdw"></exec>
      <wait label="Jacking" retry="40">
        <stat ins="dsi" ref="exe">OFF</stat>
      </wait>
      <check label="Jack DW?">
        <stat ins="dsi" ref="fjb">DW</stat>
      </check>
    </command>
    <command id="jd0d" label="InR0 Jkdw at FIX.IR">
      <break label="Instrument ON?">
        <stat ins="dsi" ref="fis">ON</stat>
      </break>
      <check label="HOOK?">
        <stat ins="dsi" ref="fhk">HOOK</stat>
      </check>
      <exec ins="dsi" name="fjup"></exec>
      <wait label="Jacking" retry="40">
        <stat ins="dsi" ref="exe">OFF</stat>
      </wait>
      <check label="Jack UP?">
        <stat ins="dsi" ref="fjb">UP</stat>
      </check>
    </command>
    <command id="ju4d" label="InR4 Jkup at FIX.IR">
      <break label="Jack Up?">
        <stat ins="dsi" ref="fjb">UP</stat>
      </break>
      <check label="UNHOOK?">
        <stat ins="dsi" ref="fhk">UNHK</stat>
      </check>
      <exec ins="dsi" name="fjup"></exec>
      <wait label="Jacking" retry="40">
        <stat ins="dsi" ref="exe">OFF</stat>
      </wait>
      <check label="Jack UP?">
        <stat ins="dsi" ref="fjb">UP</stat>
      </check>
    </command>
    <command id="jd4d" label="InR4 Jkdw at FIX.IR">
      <break label="Jack Dw?">
        <stat ins="dsi" ref="fjb">DW</stat>
      </break>
      <check label="UNHOOK?">
        <stat ins="dsi" ref="fhk">UNHK</stat>
      </check>
      <exec ins="dsi" name="fjdw"></exec>
      <wait label="Jacking" retry="40">
        <stat ins="dsi" ref="exe">OFF</stat>
      </wait>
      <check label="Jack DW?">
        <stat ins="dsi" ref="fjb">DW</stat>
      </check>
    </command>
    <!--Jack & Rotate-->
    <command id="jupd" label="HookUp at FIX.IR">
      <break label="Instrument ON?">
        <stat ins="dsi" ref="fis">ON</stat>
      </break>
      <check label="CART ON TAG?">
        <stat ins="crt" ref="cpos">12</stat>
        <stat ins="crt" ref="jpos">H</stat>
      </check>
      <exec ins="dsi" name="fhook"></exec>
      <wait label="Jacking" retry="40">
        <stat ins="dsi" ref="exe">OFF</stat>
      </wait>
      <mcr name="ju0d" />
      <check label="Instrument ON?">
        <stat ins="dsi" ref="fis">ON</stat>
      </check>
    </command>
    <!--Transer-->
    <command id="trsi" label="MOV.IR Trans Backward w/INST">
      <break label="Transer Stored?">
        <stat ins="dsi" ref="mtr">BK</stat>
      </break>
      <check label="CART CLEAR?">
        <stat ins="crt" ref="cpos" inv="true">12</stat>
        <stat ins="crt" ref="cpos" inv="true">11</stat>
      </check>
      <exec ins="dsi" name="rotin"></exec>
      <wait label="Rotating" retry="20">
        <stat ins="dsi" ref="exe">OFF</stat>
      </wait>
      <exec ins="dsi" name="trin"></exec>
      <wait label="Moving" retry="60">
        <stat ins="dsi" ref="exe">OFF</stat>
      </wait>
      <check label="Transer Stored?">
        <stat ins="dsi" ref="mtr">BK</stat>
      </check>
    </command>
    <!--Run & Transer-->
    <command id="lv08to" label="Leave IR from Tag 8 to [2-7]">
      <par>2:7</par>
      <break label="Leave Cart and Transer Stored?">
        <stat ins="crt" ref="cpos" inv="true">8</stat>
        <stat ins="dsi" ref="mtr">BK</stat>
      </break>
      <check label="CART CLEAR?">
        <stat ins="crt" ref="cpos">8</stat>
        <stat ins="crt" ref="ion">OFF</stat>
      </check>
      <exec ins="crt" name="run">
        <argv>$1</argv>
      </exec>
      <mcr async="true" name="trsi" />
      <wait retry="120" label="Run end?">
        <stat label="Running" ref="run" ins="crt">OFF</stat>
      </wait>
      <check label="Leave Cart and Transer Stored?">
        <stat ins="crt" ref="cpos" inv="true">8</stat>
        <stat ins="dsi" ref="mtr">BK</stat>
      </check>
    </command>
  </macro>
</mdb>