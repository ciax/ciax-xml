<?xml version="1.0" encoding="utf-8"?>
<cdb xsi:schemaLocation="http://ciax.sum.naoj.org/ciax-xml/schema/cdb.xsd" xmlns="http://ciax.sum.naoj.org/ciax-xml/cdb" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <class frame="ixe" id="ixe" label="MOIRCS Turret">
    <commands xmlns="http://ciax.sum.naoj.org/ciax-xml/cdbc">
      <session id="upd" label="Update Status">
        <statement command="getstat" />
        <repeat from="1" to="6">
          <statement command="chkrun">
            <argv>$_</argv>
          </statement>
          <statement command="getp">
            <argv>$_</argv>
          </statement>
          <statement command="getspd">
            <argv>$_</argv>
          </statement>
          <statement command="getofs">
            <argv>$_</argv>
          </statement>
        </repeat>
      </session>
      <session id="sysinit" label="System Initialize">
        <statement command="initrot" />
        <statement command="initunit" />
        <statement command="initfactor" />
      </session>
      <session id="posinit" label="Position Initialize">
        <repeat from="1" to="6">
          <statement command="init">
            <argv>$_</argv>
          </statement>
          <statement command="chkrun">
            <argv>$_</argv>
          </statement>
        </repeat>
      </session>
      <session id="speed" label="Set Speed [0-800]">
        <parameters>
          <par label="[0-800]" validate="range">0:800</par>
        </parameters>
        <repeat from="1" to="6">
          <statement command="set">
            <argv format="spd:%d">$_-1</argv>
            <argv>$1</argv>
          </statement>
          <statement command="setspd">
            <argv>$_</argv>
          </statement>
        </repeat>
      </session>
      <session id="resetp" label="Set 0 Pulses">
        <repeat from="1" to="6">
          <statement command="set">
            <argv format="p:%d">$_-1</argv>
            <argv>0</argv>
          </statement>
          <statement command="setp">
            <argv>$_</argv>
          </statement>
        </repeat>
      </session>
      <session id="backup" label="Backup Pulse,Speed,Offset">
        <statement command="save">
          <argv>p,spd,ofs</argv>
        </statement>
        <statement command="deact" />
      </session>
      <session id="restore" label="Restore Pulse,Speed,Offset">
        <statement command="act" />
        <statement command="load" />
        <repeat from="1" to="6">
          <statement command="setp">
            <argv>$_</argv>
          </statement>
          <statement command="setspd">
            <argv>$_</argv>
          </statement>
          <statement command="setofs">
            <argv>$_</argv>
          </statement>
        </repeat>
      </session>
      <session id="fw" label="Move Forward [1-6] [1-(hole)]">
        <parameters>
          <par label="[1-6(Turret)]" validate="range">1:6</par>
          <par label="[1-(hole)]" validate="range">1:</par>
        </parameters>
        <statement command="fw">
          <argv>$1</argv>
          <argv format="%d">$2 * 8000</argv>
        </statement>
        <statement command="chkrun">
          <argv>$1</argv>
        </statement>
      </session>
      <session id="bk" label="Move Backward [1-6] [1-(hole)]">
        <parameters>
          <par label="[1-6(Turret)]" validate="range">1:6</par>
          <par label="[1-(hole)]" validate="range">1:</par>
        </parameters>
        <statement command="bk">
          <argv>$1</argv>
          <argv format="%d">$2 * 8000</argv>
        </statement>
        <statement command="chkrun">
          <argv>$1</argv>
        </statement>
      </session>
      <session id="abs" label="Move Absolute [1-6] [0-48(hole)]">
        <parameters>
          <par label="[1-6]" validate="range">1:6</par>
          <par label="[0-48(hole)]" validate="range">0:48</par>
        </parameters>
        <statement command="abs">
          <argv>$1</argv>
          <argv format="%d">$2 * 8000</argv>
        </statement>
        <statement command="chkrun">
          <argv>$1</argv>
        </statement>
      </session>
      <session id="upp">
        <!--Update Pulse [1-6]-->
        <parameters>
          <par label="[1-6]" validate="range">1:6</par>
        </parameters>
        <statement command="chkrun">
          <argv>$1</argv>
        </statement>
        <statement command="getp">
          <argv>$1</argv>
        </statement>
      </session>
      <session id="stop">
        <!--Motor Stop [1-6]-->
        <parameters>
          <par label="[1-6]" validate="range">1:6</par>
        </parameters>
        <statement command="stop">
          <argv>$1</argv>
        </statement>
      </session>
    </commands>
    <watch interval="1" xmlns="http://ciax.sum.naoj.org/ciax-xml/wdb">
      <periodic label="Update Status" period="3600">
        <statement command="upd" />
      </periodic>
      <repeat from="1" to="6">
        <while label="Moving %d" ref="r%d" val="N" blocking="(fw|bk|abs) %d">
          <interrupt command="stop">
            <argv>$_</argv>
          </interrupt>
          <statement command="chkrun">
            <argv>$_</argv>
          </statement>
          <statement command="getp">
            <argv>$_</argv>
          </statement>
        </while>
      </repeat>
    </watch>
    <status xmlns="http://ciax.sum.naoj.org/ciax-xml/cdbs">
      <value id="rdy" label="Comm Ready" group="s1">
        <binary bit="0" ref="stat" />
      </value>
      <value id="srq" label="SRQ" group="s1">
        <binary bit="1" ref="stat" />
      </value>
      <value id="pme" label="Program Error" group="s1">
        <binary bit="3" ref="stat" />
      </value>
      <value id="pse" label="Power Stage Error" group="s1">
        <binary bit="4" ref="stat" />
      </value>
      <value id="oes" label="ONE EM Stop" group="s1">
        <binary bit="5" ref="stat" />
      </value>
      <value id="ees" label="EXT EM Stop" group="s1">
        <binary bit="6" ref="stat" />
      </value>
      <value id="trm" label="Terminal Mode" group="s2">
        <binary bit="2" ref="stat" />
      </value>
      <value id="cmd" label="Computer Mode" group="s2">
        <binary bit="7" ref="stat" />
      </value>
      <repeat from="1" to="6">
        <value id="r%d" label="Running %d" group="r%d">
          <string ref="run:$_-1" />
        </value>
        <value id="p%d" label="Pulse %d" group="r%d">
          <int ref="p:$_-1" />
        </value>
        <value id="spd%d" label="Speed %d" group="r%d">
          <int ref="spd:$_-1" />
        </value>
        <value id="ofs%d" label="Offset %d" group="r%d">
          <int ref="ofs:$_-1" />
        </value>
      </repeat>
    </status>
    <symbol xmlns="http://ciax.sum.naoj.org/ciax-xml/sdb">
      <case id="rdy" ref="off-warn" />
      <case id="srq" ref="off-warn" />
      <case id="pme" ref="alarm" />
      <case id="pse" ref="alarm" />
      <case id="oes" ref="alarm" />
      <case id="ees" ref="alarm" />
      <case id="trm" ref="off-warn" />
      <case id="cmd" ref="off-warn" />
    </symbol>
  </class>
</cdb>