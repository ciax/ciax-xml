<?xml version="1.0" encoding="utf-8"?>
<adb xmlns="http://ciax.sum.naoj.org/ciax-xml/adb">
  <app frm_type="mel" id="mel" label="Cart PLC" version="1">
    <commands xmlns="http://ciax.sum.naoj.org/ciax-xml/adbc">
      <group id="gint" caption="Interrupt Commands">
        <command id="upd" label="Regular status update">
          <frmcmd name="getstat" />
          <frmcmd name="getcmd" />
        </command>
        <command id="ready" label="Ready mode">
          <frmcmd name="stop">
            <argv>6</argv>
          </frmcmd>
          <frmcmd name="sleep">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
          <frmcmd name="getstat" />
        </command>
        <command id="emstop" label="Emergency Stop">
          <frmcmd name="stop">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="sleep">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="clear" />
          <frmcmd name="getstat" />
        </command>
        <command id="pause" label="Pause">
          <frmcmd name="stop">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="sleep">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="clear" />
          <frmcmd name="getstat" />
        </command>
        <command id="reset" label="Reset Error or Pause">
          <frmcmd name="stop">
            <argv>5</argv>
          </frmcmd>
          <frmcmd name="sleep">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="clear" />
          <frmcmd name="getstat" />
        </command>
        <command id="cancel" label="Command Cancel">
          <frmcmd name="stop">
            <argv>4</argv>
          </frmcmd>
          <frmcmd name="sleep">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="clear" />
          <frmcmd name="getstat" />
        </command>
        <command id="cstop" label="Stop at Next Tag">
          <frmcmd name="stop">
            <argv>7</argv>
          </frmcmd>
          <frmcmd name="sleep">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="clear" />
          <frmcmd name="getstat" />
        </command>
        <command id="clear" label="Clear Cmd Flag" hidden="true">
          <frmcmd name="clear" />
          <frmcmd name="getcmd" />
        </command>
      </group>
      <group id="gmov" caption="Moving Commands">
        <command id="run" label="Run to Destination Tag [1-12]">
          <par>1:12</par>
          <frmcmd name="set_tag">
            <argv>$1</argv>
          </frmcmd>
          <frmcmd name="start">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="fwd" label="Run Forward">
          <frmcmd name="set_tag">
            <argv>98</argv>
          </frmcmd>
          <frmcmd name="start">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="bak" label="Run Backword">
          <frmcmd name="set_tag">
            <argv>99</argv>
          </frmcmd>
          <frmcmd name="start">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="lift" label="Lift Jack Level [0-3]">
          <par>0:3</par>
          <frmcmd name="set_pos">
            <argv>$1</argv>
          </frmcmd>
          <frmcmd name="start">
            <argv>8</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
      </group>
      <group id="gins" caption="Instrument Assign">
        <command id="moircs" label="MOIRCS">
          <frmcmd name="set_ins">
            <argv>2</argv>
          </frmcmd>
          <frmcmd name="getstat" />
        </command>
        <command id="ciao" label="CIAO">
          <frmcmd name="set_ins">
            <argv>3</argv>
          </frmcmd>
          <frmcmd name="getstat" />
        </command>
      </group>
      <group id="gchg" caption="Charging Commands">
        <command id="chgon" label="Start Charging">
          <frmcmd name="start">
            <argv>15</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="chgoff" label="Stop Charging">
          <frmcmd name="stop">
            <argv format="%d">3</argv>
          </frmcmd>
          <frmcmd name="clear" />
          <frmcmd name="getstat" />
        </command>
      </group>
      <group id="gmtn" caption="Maintenance Commands">
        <command id="get_tbl" label="Get Jack Table">
          <frmcmd name="rw_tbl">
            <argv>1</argv>
          </frmcmd>
          <repeat counter="t" from="0" to="5">
            <repeat counter="j" from="0" to="3">
              <frmcmd name="get_tbl">
                <argv>$t</argv>
                <argv>$j</argv>
              </frmcmd>
            </repeat>
          </repeat>
        </command>
        <command id="set_tbl" label="Set Jack Table">
          <repeat counter="t" from="0" to="5">
            <repeat counter="j" from="0" to="3">
              <frmcmd name="set_tbl">
                <argv>$t</argv>
                <argv>$j</argv>
              </frmcmd>
            </repeat>
          </repeat>
          <frmcmd name="rw_tbl">
            <argv>0</argv>
          </frmcmd>
        </command>
      </group>
    </commands>
    <status xmlns="http://ciax.sum.naoj.org/ciax-xml/adbs" table="mel">
      <group id="g1" caption="Main" column="4">
        <value id="rdy" label="READY" symbol="normal">
          <binary bit="0" ref="x:0" />
        </value>
        <value id="pse" label="PAUSE" symbol="warn">
          <binary bit="1" ref="x:0" />
        </value>
        <value id="stp" label="STOP" symbol="warn">
          <binary bit="3" ref="x:0" />
        </value>
        <value id="isu" label="ISSUED" symbol="nonzero">
          <binary ref="c:2" bit="0" />
          <binary ref="c:2" bit="8" />
          <binary ref="c:2" bit="15" />
        </value>
        <value id="ecode" label="EXIT CODE" symbol="ecode" format="%04X">
          <int ref="ecode" />
        </value>
        <value id="flt" label="Fault" symbol="alarm">
          <binary bit="7" ref="x:0" />
        </value>
        <value id="emg" label="ENERGENCY" symbol="alarm">
          <binary bit="2" ref="x:0" />
        </value>
      </group>
      <group id="g2" caption="Action" column="4">
        <value id="acp" label="CMD RDY" symbol="acp">
          <binary label="Command Receive Enable" bit="0" ref="x:32" />
        </value>
        <value id="run" label="RUNNING" symbol="exec">
          <binary bit="4" ref="x:0" />
        </value>
        <value id="jak" label="JACKING" symbol="exec">
          <binary bit="5" ref="x:0" />
        </value>
        <value id="con" label="CHARGING" symbol="exec">
          <binary bit="6" ref="x:0" />
        </value>
      </group>
      <group id="g3" caption="Traveling Motor Stat" column="2">
        <value id="msr" label="Right Servo" symbol="normal">
          <binary bit="8" inv="true" ref="x:0" />
        </value>
        <value id="msl" label="Left Servo" symbol="normal">
          <binary bit="9" inv="true" ref="x:0" />
        </value>
        <value id="mdar" label="Rignt D/A" symbol="motor">
          <int ref="x:7" />
        </value>
        <value id="mdal" label="Left D/A" symbol="motor">
          <int ref="x:8" />
        </value>
      </group>
      <group id="g4" caption="Jacking Motor Servo" column="4">
        <repeat from="1" to="4">
          <value id="jd%d" label="%d" symbol="normal">
            <binary bit="9+$_" inv="true" ref="x:0" />
          </value>
        </repeat>
      </group>
      <group id="g5" caption="Etc" column="2">
        <value id="bvl" label="Battery Voltage" symbol="bvl" format="%2.2f">
          <float ref="x:22" formula="$#/100" />
        </value>
        <value id="ist" label="Instrument" symbol="ist">
          <int ref="x:23" />
        </value>
        <value id="cpos" label="Current Position">
          <int ref="x:25" />
        </value>
        <value id="dpos" label="Destination Position">
          <int ref="x:26" />
        </value>
        <value id="jpos" label="Jack Position" symbol="jpos">
          <int ref="x:27" />
        </value>
      </group>
    </status>
    <watch xmlns="http://ciax.sum.naoj.org/ciax-xml/wdb" interval="1">
      <event label="Periodic">
        <range ref="elapse">300:</range>
        <exec name="upd"></exec>
      </event>
      <event label="During Issued">
        <pattern ref="isu" inv="1">0</pattern>
        <block name="run" />
        <block name="jak" />
        <block name="chgon" />
        <exec name="upd"></exec>
      </event>
      <event label="Command Receive">
        <onchange ref="acp"></onchange>
        <pattern ref="acp">0</pattern>
        <exec name="clear"></exec>
        <exec name="upd"></exec>
      </event>
      <event label="While Running">
        <pattern ref="run">1</pattern>
        <block name="run" />
        <block name="jak" />
        <block name="chgon" />
        <block name="chgoff" />
        <int name="pause" />
        <exec name="upd"></exec>
      </event>
      <event label="While Jacking">
        <pattern ref="jak">1</pattern>
        <block name="run" />
        <block name="jak" />
        <block name="chgon" />
        <block name="chgoff" />
        <int name="pause" />
        <exec name="upd" />
      </event>
    </watch>
  </app>
</adb>