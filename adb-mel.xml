<?xml version="1.0" encoding="utf-8"?>
<adb xmlns="http://ciax.sum.naoj.org/ciax-xml/adb">
  <app frm_type="mel" id="mel" label="Cart PLC">
    <commands xmlns="http://ciax.sum.naoj.org/ciax-xml/adbc">
      <cmdset id="upd" label="Regular status update">
        <command name="getstat" />
      </cmdset>
      <cmdset id="run" label="Run to Destination Tag [1-12]">
        <command name="set_tag">
          <argv valid="1:12">$1</argv>
        </command>
        <command name="start">
          <argv>0</argv>
        </command>
        <command name="getstat" />
      </cmdset>
      <cmdset id="fwd" label="Run Forward">
        <command name="set_tag">
          <argv>98</argv>
        </command>
        <command name="start">
          <argv>0</argv>
        </command>
        <command name="getstat" />
      </cmdset>
      <cmdset id="bak" label="Run Backword">
        <command name="set_tag">
          <argv>99</argv>
        </command>
        <command name="start">
          <argv>0</argv>
        </command>
        <command name="getstat" />
      </cmdset>
      <cmdset id="lift" label="Lift Jack Level [0-3]">
        <command name="set_pos">
          <argv valid="0:3">$1</argv>
        </command>
        <command name="start">
          <argv>8</argv>
        </command>
        <command name="getstat" />
      </cmdset>
      <cmdset id="chgon" label="Start Charging">
        <command name="start">
          <argv>15</argv>
        </command>
        <command name="clear" />
        <command name="getstat" />
      </cmdset>
      <cmdset id="chgoff" label="Stop Charging">
        <command name="stop">
          <argv format="%d">3</argv>
        </command>
        <command name="getstat" />
        <command name="clear" />
        <command name="getstat" />
      </cmdset>
      <cmdset id="pause" label="Pause">
        <command name="stop">
          <argv>0</argv>
        </command>
        <command name="clear" />
      </cmdset>
      <cmdset id="emstop" label="Emergency Stop">
        <command name="stop">
          <argv>1</argv>
        </command>
        <command name="clear" />
      </cmdset>
      <cmdset id="resume" label="Resume from Pause">
        <command name="stop">
          <argv>5</argv>
        </command>
        <command name="clear" />
      </cmdset>
      <cmdset id="cancel" label="Command Cancel">
        <command name="stop">
          <argv>4</argv>
        </command>
        <command name="clear" />
      </cmdset>
      <cmdset id="get_tbl" label="Get Jack Table">
        <command name="rw_tbl">
          <argv>1</argv>
        </command>
        <repeat counter="t" from="0" to="5">
          <repeat counter="j" from="0" to="3">
            <command name="get_tbl">
              <argv>$t</argv>
              <argv>$j</argv>
            </command>
          </repeat>
        </repeat>
      </cmdset>
      <cmdset id="set_tbl" label="Set Jack Table">
        <repeat counter="t" from="0" to="5">
          <repeat counter="j" from="0" to="3">
            <command name="set_tbl">
              <argv>$t</argv>
              <argv>$j</argv>
            </command>
          </repeat>
        </repeat>
        <command name="rw_tbl">
          <argv>0</argv>
        </command>
      </cmdset>
    </commands>
    <status xmlns="http://ciax.sum.naoj.org/ciax-xml/adbs" table="mel">
      <group id="g1" label="Main">
        <row>
          <value id="rdy" label="READY" symbol="normal">
            <binary bit="0" ref="x:0" />
          </value>
          <value id="acp" label="CMD ACCEPT">
            <binary bit="6" ref="x:0" />
            <binary bit="0" ref="x:32" />
          </value>
        </row>
        <row>
          <value id="pse" label="PAUSE" symbol="warn">
            <binary bit="1" ref="x:0" />
          </value>
          <value id="stp" label="STOP" symbol="warn">
            <binary bit="3" ref="x:0" />
          </value>
        </row>
        <row>
          <value id="ecode" label="EXIT CODE" symbol="ecode">
            <int format="%04X" ref="ecode" />
          </value>
          <value id="flt" label="Fault" symbol="alarm">
            <binary bit="7" ref="x:0" />
          </value>
          <value id="emg" label="ENERGENCY" symbol="alarm">
            <binary bit="2" ref="x:0" />
          </value>
        </row>
      </group>
      <group id="g2" label="Action">
        <row>
          <value id="run" label="RUNNING" symbol="normal">
            <binary bit="4" ref="x:0" />
          </value>
          <value id="jak" label="JACKING" symbol="normal">
            <binary bit="5" ref="x:0" />
          </value>
          <value id="con" label="CHARGING" symbol="normal">
            <binary bit="6" ref="x:0" />
          </value>
        </row>
      </group>
      <group id="g3" label="Traveling Motor Stat">
        <row>
          <value id="msr" label="Right Servo" symbol="normal">
            <binary bit="8" inv="true" ref="x:0" />
          </value>
          <value id="msl" label="Left Servo" symbol="normal">
            <binary bit="9" inv="true" ref="x:0" />
          </value>
        </row>
        <row>
          <value id="mdar" label="Rignt D/A" symbol="motor">
            <int ref="x:7" />
          </value>
          <value id="mdal" label="Left D/A" symbol="motor">
            <int ref="x:8" />
          </value>
        </row>
      </group>
      <group id="g4" label="Jacking Motor Servo">
        <row>
          <repeat from="1" to="4">
            <value id="jd%d" label="%d" symbol="normal">
              <binary bit="9+$_" inv="true" ref="x:0" />
            </value>
          </repeat>
        </row>
      </group>
      <group id="g5" label="Etc">
        <row label="Group">
          <value id="bvl" label="Battery Voltage" symbol="bvl">
            <float format="%2.2f" ref="x:22" formula="$#/100" />
          </value>
          <value id="ist" label="Instrument" symbol="ist">
            <int ref="x:23" />
          </value>
        </row>
        <row label="Group">
          <value id="cpos" label="Current Position">
            <int ref="x:25" />
          </value>
          <value id="dpos" label="Destination Position">
            <int ref="x:26" />
          </value>
        </row>
        <row label="Group">
          <value id="jpos" label="Jack Position" symbol="jpos">
            <int ref="x:27" />
          </value>
        </row>
      </group>
    </status>
    <watch xmlns="http://ciax.sum.naoj.org/ciax-xml/wdb" interval="1">
      <periodic period="3600">
        <command name="getstat" />
      </periodic>
      <onchange label="CMD ACCEPT">
        <condition>
          <value ref="acp">00</value>
        </condition>
        <command name="clear" />
      </onchange>
      <while blocking="run|jak|charge">
        <condition>
          <value ref="acp">00</value>
        </condition>
        <interrupt name="stop">
          <argv>0</argv>
        </interrupt>
        <command name="getstat" />
      </while>
    </watch>
  </app>
</adb>
