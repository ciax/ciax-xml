<?xml version="1.0" encoding="utf-8"?>
<adb xmlns="http://ciax.sum.naoj.org/ciax-xml/adb">
  <app frm_type="mel" id="mel" label="Cart PLC" version="5">
    <commands xmlns="http://ciax.sum.naoj.org/ciax-xml/adbc">
      <group id="gint" caption="Interrupt Commands" column="2">
        <command id="upd" label="Status update">
          <frmcmd name="getstat" />
          <frmcmd name="getcmd" />
        </command>
        <command id="ready" label="Ready mode">
          <frmcmd name="int">
            <argv>6</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
          <frmcmd name="getstat" />
        </command>
        <command id="emstop" label="Emergency Stop">
          <frmcmd name="int">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="clr_int" />
          <frmcmd name="getstat" />
        </command>
        <command id="clear" label="Clear Error">
          <frmcmd name="int">
            <argv>5</argv>
          </frmcmd>
          <frmcmd name="clr_int" />
          <frmcmd name="getstat" />
        </command>
        <command id="pause" label="Pause Action">
          <frmcmd name="int">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="clr_int" />
          <frmcmd name="clr_act" />
          <frmcmd name="getcmd" />
          <frmcmd name="getstat" />
        </command>
        <command id="resume" label="Resume from Pause">
          <frmcmd name="int">
            <argv>5</argv>
          </frmcmd>
          <frmcmd name="clr_int" />
          <frmcmd name="getstat" />
        </command>
        <command id="cancel" label="Command Cancel">
          <frmcmd name="int">
            <argv>4</argv>
          </frmcmd>
          <frmcmd name="clr_int" />
          <frmcmd name="getstat" />
        </command>
        <command id="cstop" label="Stop at Next Tag">
          <frmcmd name="int">
            <argv>7</argv>
          </frmcmd>
          <frmcmd name="clr_int" />
          <frmcmd name="getstat" />
        </command>
        <command id="reset" label="Reset Cmd Flag" hidden="true">
          <frmcmd name="clr_act" />
          <frmcmd name="getcmd" />
        </command>
      </group>
      <group id="grun" caption="Run Commands" column="2">
        <command id="run" label="Run to Tag [1-12]">
          <par_num>1:12</par_num>
          <frmcmd name="set_tag">
            <argv>$1</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="run1" label="Run to Tag 1">
          <frmcmd name="set_tag">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="run2" label="Run to Tag 2">
          <frmcmd name="set_tag">
            <argv>2</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="run3" label="Run to Tag 3">
          <frmcmd name="set_tag">
            <argv>3</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="run7" label="Run to Tag 7">
          <frmcmd name="set_tag">
            <argv>7</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="run8" label="Run to Tag 8">
          <frmcmd name="set_tag">
            <argv>8</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="run9" label="Run to Tag 9">
          <frmcmd name="set_tag">
            <argv>9</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="run10" label="Run to Tag 10">
          <frmcmd name="set_tag">
            <argv>10</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="run11" label="Run to Tag 11">
          <frmcmd name="set_tag">
            <argv>11</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="run12" label="Run to Tag 12">
          <frmcmd name="set_tag">
            <argv>12</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="runf" label="Run Forward">
          <frmcmd name="set_tag">
            <argv>98</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="runb" label="Run Backword">
          <frmcmd name="set_tag">
            <argv>99</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
      </group>
      <group id="gjak" caption="Jak Commands" column="2">
        <command id="lftdw" label="Lift Down Level">
          <frmcmd name="set_pos">
            <argv>0</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>8</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="lftup1" label="Lift Low Level">
          <frmcmd name="set_pos">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>8</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="lftup2" label="Lift Mid Level">
          <frmcmd name="set_pos">
            <argv>2</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>8</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="lftup3" label="Lift High Level">
          <frmcmd name="set_pos">
            <argv>3</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>8</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
        <command id="lftchg" label="Lift Charge Level">
          <frmcmd name="set_pos">
            <argv>4</argv>
          </frmcmd>
          <frmcmd name="act">
            <argv>8</argv>
          </frmcmd>
          <frmcmd name="getcmd" />
        </command>
      </group>
      <group id="gins" caption="Instrument Assign" column="2">
        <command id="comics" label="COMICS">
          <frmcmd name="set_ins">
            <argv>1</argv>
          </frmcmd>
          <frmcmd name="getstat" />
        </command>
        <command id="ciao" label="CIAO">
          <frmcmd name="set_ins">
            <argv>2</argv>
          </frmcmd>
          <frmcmd name="getstat" />
        </command>
        <command id="focas" label="FOCAS">
          <frmcmd name="set_ins">
            <argv>3</argv>
          </frmcmd>
          <frmcmd name="getstat" />
        </command>
        <command id="moircs" label="MOIRCS">
          <frmcmd name="set_ins">
            <argv>4</argv>
          </frmcmd>
          <frmcmd name="getstat" />
        </command>
        <command id="k3d" label="Kyoto 3D">
          <frmcmd name="set_ins">
            <argv>5</argv>
          </frmcmd>
          <frmcmd name="getstat" />
        </command>
      </group>
      <group id="gchg" caption="Charging Commands" column="2">
        <command id="chgon" label="Start Charging">
          <frmcmd name="act">
            <argv>15</argv>
          </frmcmd>
          <frmcmd name="getcmd"></frmcmd>
        </command>
        <command id="chgoff" label="Stop Charging">
          <frmcmd name="int">
            <argv format="%d">3</argv>
          </frmcmd>
          <frmcmd name="clr_int" />
          <frmcmd name="getstat" />
        </command>
      </group>
      <group id="gmtn" caption="Maintenance Commands" column="2">
        <command id="get_tbl" label="Get Jack Table">
          <frmcmd name="rw_tbl">
            <argv>1</argv>
          </frmcmd>
          <repeat counter="t" from="0" to="5">
            <repeat counter="j" from="0" to="3">
              <frmcmd name="get_tbl">
                <argv>$t</argv>
                <argv>$j</argv>
              </frmcmd>
            </repeat>
          </repeat>
        </command>
        <command id="set_tbl" label="Set Jack Table">
          <repeat counter="t" from="0" to="5">
            <repeat counter="j" from="0" to="3">
              <frmcmd name="set_tbl">
                <argv>$t</argv>
                <argv>$j</argv>
              </frmcmd>
            </repeat>
          </repeat>
          <frmcmd name="rw_tbl">
            <argv>0</argv>
          </frmcmd>
        </command>
      </group>
    </commands>
    <status xmlns="http://ciax.sum.naoj.org/ciax-xml/adbs" table="mel">
      <group id="gs" caption="Status" column="3">
        <binary id="rdy" label="READY" symbol="off-alarm">
          <normal ref="x" index="0" bit="0" />
        </binary>
        <binary id="stp" label="STOPPING" symbol="off-warn">
          <normal ref="x" index="0" bit="3" />
        </binary>
        <binary id="pse" label="PAUSE" symbol="action">
          <normal ref="x" index="0" bit="1" />
        </binary>
        <binary id="emg" label="ENERGENCY" symbol="alarm">
          <normal ref="x" index="0" bit="2" />
        </binary>
        <integer id="exc" label="EXIT CODE" symbol="ecode" format="%04X">
          <field ref="ecode" />
        </integer>
        <binary id="flt" label="Fault" symbol="alarm">
          <normal ref="x" index="0" bit="7" />
        </binary>
      </group>
      <group id="gt" caption="Trigger" column="4">
        <binary id="acp" label="CMD ENB" symbol="acp">
          <normal label="Command Receive Enable" ref="x" index="32" bit="0" />
        </binary>
        <binary id="isu" label="ISSUED" symbol="nonzero">
          <normal ref="c" index="2" bit="0" />
          <normal ref="c" index="2" bit="8" />
          <normal ref="c" index="2" bit="15" />
        </binary>
      </group>
      <group id="gins" caption="Instrument" column="2">
        <integer id="ist" label="ID" symbol="ist">
          <field ref="x" index="23" />
        </integer>
        <binary id="ion" label="Loading" symbol="corn">
          <normal ref="x" index="4" bit="8" />
          <normal ref="x" index="4" bit="9" />
          <normal ref="x" index="4" bit="10" />
          <normal ref="x" index="4" bit="11" />
        </binary>
      </group>
      <group id="gact" caption="Motion Status" column="3">
        <binary id="run" label="RUNNING" symbol="action">
          <normal ref="x" index="0" bit="4" />
        </binary>
        <integer id="cps" label="Current Tag" format="%02d">
          <field ref="x" index="25" />
        </integer>
        <integer id="dps" label="Destination Tag" format="%02d">
          <field ref="x" index="26" />
        </integer>
        <binary id="jak" label="JACKING" symbol="action">
          <normal ref="x" index="0" bit="5" />
        </binary>
        <integer id="jlv" label="Jack Level" symbol="jlv">
          <field ref="x" index="27" />
        </integer>
        <binary id="con" label="Corn" symbol="corn">
          <normal ref="x" index="19" bit="5" />
          <normal ref="x" index="19" bit="13" />
          <normal ref="x" index="20" bit="5" />
          <normal ref="x" index="20" bit="13" />
        </binary>
        <binary id="chg" label="CHARGING" symbol="action">
          <normal ref="x" index="0" bit="6" />
        </binary>
        <float id="vol" label="Battery(V)" symbol="bvl" format="%02.2f" formula="$#/100">
          <field ref="x" index="22" />
        </float>
      </group>
      <group id="gmot" caption="Running Motor Stat" column="2">
        <binary id="msr" label="Servo R" symbol="action">
          <invert ref="x" index="0" bit="8" />
        </binary>
        <float id="mdr" label="D/A R" formula="-$#">
          <field ref="x" index="7" />
        </float>
        <binary id="msl" label="Servo L" symbol="action">
          <invert ref="x" index="0" bit="9" />
        </binary>
        <float id="mdl" label="D/A L">
          <field ref="x" index="8" />
        </float>
      </group>
      <group id="gjm" caption="Jacking Motor Stat" column="5">
        <repeat from="1" to="4">
          <binary id="js$_" label="SV $_" symbol="action">
            <invert ref="x" index="0" bit="9+$_" />
          </binary>
          <float id="jh$_" label="H(mm) $_" formula="$#/100">
            <field ref="x" index="8+2*$_" />
          </float>
          <binary id="cn$_" label="Corn $_" symbol="con">
            <normal ref="x" index="19+($_-1)/2" bit="13-($_%2)*8" />
          </binary>
          <integer id="ld$_" label="LD(Kgf) $_">
            <field ref="x" index="$_+47" />
          </integer>
          <binary id="lc$_" label="LD(S) $_" symbol="load">
            <normal ref="x" index="19+($_-1)/2" bit="8-($_%2)*8" />
            <normal ref="x" index="19+($_-1)/2" bit="9-($_%2)*8" />
            <normal ref="x" index="19+($_-1)/2" bit="10-($_%2)*8" />
            <normal ref="x" index="19+($_-1)/2" bit="11-($_%2)*8" />
            <normal ref="x" index="19+($_-1)/2" bit="12-($_%2)*8" />
          </binary>
        </repeat>
      </group>
    </status>
    <watch xmlns="http://ciax.sum.naoj.org/ciax-xml/wdb" interval="1">
      <event label="During Issued" id="isu">
        <pattern var="isu" inv="1">0</pattern>
        <block_grp ref="grun" />
        <block_grp ref="gjak" />
        <block_grp ref="gchg" />
        <exec name="upd"></exec>
      </event>
      <event label="Command Receive" id="rec">
        <pattern var="isu" inv="true">0</pattern>
        <pattern var="acp">0</pattern>
        <exec name="reset"></exec>
        <exec name="upd"></exec>
      </event>
      <event label="While Running" id="run">
        <pattern var="run">1</pattern>
        <block_grp ref="grun" />
        <block_grp ref="gjak" />
        <block_grp ref="gchg" />
        <int name="pause" />
        <exec name="upd"></exec>
      </event>
      <event label="While Jacking" id="jak">
        <pattern var="jak">1</pattern>
        <block_grp ref="grun" />
        <block_grp ref="gjak" />
        <block_grp ref="gchg" />
        <int name="pause" />
        <exec name="upd" />
      </event>
    </watch>
  </app>
</adb>